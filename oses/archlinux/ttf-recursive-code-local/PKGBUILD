# shellcheck shell=bash disable=SC2034,2154
pkgname=ttf-recursive-code-local
pkgver=v1.084
pkgrel=1
pkgdesc="Recursive Code Local"
arch=(any)
makedepends=(git python python-virtualenv python-pip)
conflicts=(ttf-recursive otf-recursive)
source=(
    'git+https://github.com/arrowtype/recursive-code-config.git'
    'casual_liga.yaml'
    'casual.yaml'
    'duotone_liga.yaml'
    'duotone.yaml'
    'linear_liga.yaml'
    'linear.yaml'
    'semicasual_liga.yaml'
    'semicasual.yaml'
)
sha256sums=(
    'SKIP'
    '476afd62260551ca1f3f33f80c86cdcffe01d96bd8676bc3ea4e384fdddf259f'
    '39ddd3cf57aa465a2bc62c8ae4f58428bc8c9e6a05d368b397bf8ed0f197ea3b'
    '62c20cacb8f17bece3b6eb3ca1a7ee428e6329bbb93353e5f78a5f8504eee808'
    '808f5e7569393f9d9825878b9158e024a81e71ef209d29131312685b81d71e0d'
    'b644187dcbe918b86f8d9f8f16cc50aeb5ac11051f9a05bbba88c086d559802e'
    '2a4c175329336e96919c9aa23e02dd4cea7b8c3f0af796d00670cd43f259e61c'
    '37a1d66477786175207706b0c5d3017386b4d9da13d0baa43e673dcd983c8ca0'
    'fefb9101476448d944d3b72e355279d4603af9e8ae2fa3ba8431237b4a3663d0'
)

pkgver() {
    curl -sS https://api.github.com/repos/arrowtype/recursive/releases/latest | jq -r .tag_name
}

prepare() {
    python3 -m venv venv
    # shellcheck disable=SC1091
    source venv/bin/activate
    pip install --upgrade pip
    cd recursive-code-config || return $?
    pip install -r requirements.txt
}

package() {
    cd recursive-code-config || return $?
    fontTemplate=$(find font-data -name "Recursive_*" | head -1)
    variants=(casual duotone linear semicasual casual_liga duotone_liga linear_liga semicasual_liga)
    for variant in "${variants[@]}"; do
        python3 scripts/instantiate-code-fonts.py ../"${variant}".yaml "${fontTemplate}" &
    done
    wait
    mkdir -p "${pkgdir}"/usr/share/fonts/TTF/
    cp -r fonts/* "${pkgdir}"/usr/share/fonts/TTF
}
