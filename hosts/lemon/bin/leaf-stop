#!/usr/bin/env bash
export AR_MODULE=''

gpuVM=1000
VM=$1

if [[ "${USER}" != "root" ]]; then
    echo "Please run as root"
    exit 1
fi

if [[ ! -e "/etc/pve/qemu-server/${VM}.conf" ]]; then
    echo "Unknown VM: ${VM}"
    exit 1
fi

if [[ "$(qm status "${VM}")" == "status: running" ]]; then
    echo "Shutting down ${VM}"
    sudo qm shutdown "${VM}" &> /dev/null || echo "forcing shut down ${VM}" && qm stop "${VM}"
fi
sleep 1

sudo qm set "${gpuVM}" --onboot 1 > /dev/null && echo "Enable automatic boot on ${gpuVM}"
sudo qm set "${VM}" --onboot 0 --delete hostpci0,usb0,usb1,usb2,usb3 --vga qxl > /dev/null && echo "Remove hardware from ${VM}"

if [[ "${VM}" == "1012" ]]; then
    sudo qm set "${VM}" --vga default > /dev/null && echo "Set display for macOS"
fi

echo "Starting ${gpuVM}"
sudo qm start "${gpuVM}"
